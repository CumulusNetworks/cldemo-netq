---
- hosts: network
  become: yes
  pre_tasks:
    # To prevent unexpected problems, define the minimum Cumulus Linux
    # Release supported by this demo.
    - name: Verify Minimum Software Version
      assert:
        that: "{{ansible_lsb.release | version_compare('3.4', '>=') }}"
        msg: "Cumulus Linux version must be 3.4 or later. Version {{ansible_lsb.release}} detected"

  tasks:
    - name: Enable FRR Zebra
      lineinfile:
        dest: /etc/frr/daemons
        line: "zebra=yes"
        regexp: "zebra="
      notify: restart frr service

    - name: Enable FRR BGP
      lineinfile:
        dest: /etc/frr/daemons
        line: "bgpd=yes"
        regexp: "bgpd="
      notify: restart frr service

    - name: Copy Interfaces File
      copy:
        src: configurations/{{ansible_hostname}}/interfaces
        dest: /etc/network/interfaces
        validate: ifup -a -s -i %s
      notify: apply interface changes

    - name: Copy Routing Configuration
      copy:
        src: configurations/{{ansible_hostname}}/frr.conf
        dest: /etc/frr/frr.conf
        validate: vtysh -C -f %s
      notify: apply frr config

    - name: Install NetQ
      apt:
        name: cumulus-netq
        update_cache: yes
      register: install-netq

    - name: Restart Rsyslog
      service:
        name: rsyslog
        state: restarted

    - name: Add netq server IP
      command: netq add server 192.168.0.254 vrf mgmt

    - name: Restart NetQ Agent
      command: netq agent restart

  handlers:
    - name: restart frr service
      service:
        name: frr
        state: restarted

    - name: apply interface changes
      service:
        name: networking
        state: reloaded

    - name: apply frr config
      service:
        name: frr
        state: reloaded

- hosts: servers
  become: yes
  tasks:
    - name: Copy Interface Config
      copy:
        src: configurations/{{ansible_hostname}}/interfaces
        dest: /etc/network/interfaces
      register: reboot

    - name: Correct LLDP Settings
      lineinfile:
        dest: /etc/lldpd.d/port_info.conf
        line: "configure lldp portidsubtype ifname"
        create: yes
      notify: restart LLDP

    - name: Apply LLDP Settings
      meta: flush_handlers

    - name: Install Docker-CE Repo Key
      apt_key:
        url: "https://download.docker.com/linux/ubuntu/gpg"
        state: present

    - name: Add Docker Repo
      apt_repository:
        repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu xenial stable
        state: present
        update_cache: no

    - name: Add Cumulus Apt Key
      apt_key:
        url: "https://hostapps3.cumulusnetworks.com/setup/cumulus-host-ubuntu.pubkey"
        state: present

    - name: Add Cumulus Repo
      apt_repository:
        repo: deb https://hostapps3.cumulusnetworks.com/host/ubuntu xenial universe
        state: present
        update_cache: no

    - name: Install NetQ, DockerCE, ifupdown2
      apt:
        name: "{{item}}"
        update_cache: yes
      with_items:
        - docker-ce
        - ifupdown2
        - cumulus-netq

    - name: Enable ifupdown2
      service:
        name: networking
        enabled: yes

    - name: Restart Rsyslog
      service:
        name: rsyslog
        state: restarted

    - name: Enable NetQ Service
      service:
        name: netqd
        enabled: yes
        state: started

    - name: Pause to let NetQ service to start
      pause:
        seconds: 5

    - name: Add netq server IP
      command: netq add server 192.168.0.254

    - name: Restart NetQ Agent
      command: netq agent restart

    - name: Start Docker
      service:
        name: docker
        state: started
        enabled: yes

    - name: Enable ifupdown2 after reboot
      lineinfile:
        dest: "/lib/systemd/system/networking.service"
        regexp: '^RemainAfterExit'
        insertafter: '^\[Service\]'
        line: 'RemainAfterExit=yes'

    - name: Enable eth1
      command: ifup eth1
      ignore_errors: yes

    - name: Enable eth2
      command: ifup eth2
      ignore_errors: yes

    - name: Copy Quagga daemons File
      copy:
        src: configurations/{{ansible_hostname}}/daemons
        dest: /etc/quagga/daemons

    - name: Copy Quagga configuration File
      copy:
        src: configurations/{{ansible_hostname}}/quagga.conf
        dest: /etc/quagga/quagga.conf

    - name: Deploy ROH Container
      docker_container:
        name: cumulus-roh
        privileged: true
        interactive: true
        network_mode: host
        tty: true
        recreate: yes
        image: cumulusnetworks/quagga:latest
        volumes:
          - "/etc/quagga/daemons:/etc/quagga/daemons"
          - "/etc/quagga/Quagga.conf:/etc/quagga/Quagga.conf"

  handlers:
    - name: restart LLDP
      service:
        name: lldpd
        state: restarted
